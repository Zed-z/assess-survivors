name: Multi-Platform Build
run-name: >
  ${{ github.event_name == 'workflow_dispatch' && format('Manual Build: {0} [{1}]', github.event.inputs.build_target, github.event.inputs.build_mode) || format('Tagged Release: {0}', github.ref_name) }}

permissions:
  contents: write

on:
  push:
    tags:
      - "v*"

  workflow_dispatch:
    inputs:
      build_target:
        description: "Platform"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - windows
          - linux
          - web

      build_mode:
        description: "Build Mode"
        required: true
        default: "debug"
        type: choice
        options:
          - debug
          - release

      run_tests:
        description: "Run GDUnit tests"
        type: boolean
        default: false

env:
  GODOT_VERSION: 4.5.1
  GODOT_PROJECT_FOLDER: ${{ github.workspace }}
  GODOT_PROJECT_FILE: ${{ github.workspace }}/project.godot
  EXPORT_FOLDER_WINDOWS: ${{ github.workspace }}/export/windows
  EXPORT_FOLDER_LINUX: ${{ github.workspace }}/export/linux
  EXPORT_FOLDER_WEB: ${{ github.workspace }}/export/web
  EXPORT_FOLDER_OUTPUT: ${{ github.workspace }}/export/output
  APPLICATION_NAME: assess_survivors

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Prepare build environment
        run: |
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            VERSION="${GITHUB_REF_NAME}"
          else
            DATE=$(date +'%Y-%m-%d')
            HASH=$(git rev-parse --short HEAD)
            VERSION="${DATE}-${HASH}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV

          echo "BUILD_TARGET=${{ github.event.inputs.build_target || 'all' }}" >> $GITHUB_ENV   # All platforms for tagged builds
          echo "BUILD_MODE=${{ github.event.inputs.build_mode || 'release' }}" >> $GITHUB_ENV   # Release for tagged builds
          echo "RUN_TESTS=${{ github.event.inputs.run_tests || 'false' }}" >> $GITHUB_ENV       # False by default due to crashing issues

          mkdir -p ${{ env.EXPORT_FOLDER_WINDOWS }}
          mkdir -p ${{ env.EXPORT_FOLDER_LINUX }}
          mkdir -p ${{ env.EXPORT_FOLDER_WEB }}
          mkdir -p ${{ env.EXPORT_FOLDER_OUTPUT }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip git fontconfig ca-certificates libx11-6 libxext6 libxi6 libxrandr2 libxcursor1 libxinerama1 libxxf86vm1 libglu1-mesa libpulse0 libglib2.0-0

      - name: Prepare Godot
        run: |
          wget -q -O godot_linux.zip https://github.com/godotengine/godot-builds/releases/download/${{ env.GODOT_VERSION }}-stable/Godot_v${{ env.GODOT_VERSION }}-stable_linux.x86_64.zip
          unzip godot_linux.zip
          wget -q -O godot_export_templates.tpz https://github.com/godotengine/godot-builds/releases/download/${{ env.GODOT_VERSION }}-stable/Godot_v${{ env.GODOT_VERSION }}-stable_export_templates.tpz
          mkdir -p ~/.local/share/godot/export_templates/${{ env.GODOT_VERSION }}.stable
          unzip godot_export_templates.tpz -d ~/.local/share/godot/export_templates/${{ env.GODOT_VERSION }}.stable
          mv ~/.local/share/godot/export_templates/${{ env.GODOT_VERSION }}.stable/templates/* ~/.local/share/godot/export_templates/${{ env.GODOT_VERSION }}.stable/
          chmod +x ./Godot_v${{ env.GODOT_VERSION }}-stable_linux.x86_64
          sed -i 's/config\/version="[^"]*"/config\/version="${{ env.VERSION }}-${{ env.BUILD_MODE }}"/' ${{ env.GODOT_PROJECT_FILE }}

      - name: Run GDUnit4 Tests
        if: ${{ env.RUN_TESTS == 'true' }}
        uses: MikeSchulze/gdUnit4-action@v1
        with:
          godot-version: ${{ env.GODOT_VERSION }}
          paths: "res://test"
          timeout: 10

      - name: Build Linux
        if: ${{ env.BUILD_TARGET == 'linux' || env.BUILD_TARGET == 'all' }}
        run: |
          ./Godot_v${{ env.GODOT_VERSION }}-stable_linux.x86_64 \
            --headless \
            --path ${{ env.GODOT_PROJECT_FOLDER }} \
            --export-${{ env.BUILD_MODE }} Linux ${{ env.EXPORT_FOLDER_LINUX }}/${{ env.APPLICATION_NAME }}.x86_64 || true
          chmod +x ${{ env.EXPORT_FOLDER_LINUX }}/${{ env.APPLICATION_NAME }}.x86_64
          if [ "${{ env.BUILD_MODE }}" = "debug" ]; then
            chmod +x ${{ env.EXPORT_FOLDER_LINUX }}/${{ env.APPLICATION_NAME }}.sh
          fi
          pushd ${{ env.EXPORT_FOLDER_LINUX }}
          tar -cvf ${{ env.APPLICATION_NAME }}_linux_${{ env.BUILD_MODE }}_${{ env.VERSION }}.tar .
          popd
          mv ${{ env.EXPORT_FOLDER_LINUX }}/*.tar ${{ env.EXPORT_FOLDER_OUTPUT }}/

      - name: Upload Linux artifact
        if: ${{ env.BUILD_TARGET == 'linux' || env.BUILD_TARGET == 'all' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APPLICATION_NAME }}_linux_${{ env.BUILD_MODE }}_${{ env.VERSION }}
          path: ${{ env.EXPORT_FOLDER_OUTPUT }}/${{ env.APPLICATION_NAME }}_linux_${{ env.BUILD_MODE }}_${{ env.VERSION }}.tar

      - name: Build Windows
        if: ${{ env.BUILD_TARGET == 'windows' || env.BUILD_TARGET == 'all' }}
        run: |
          ./Godot_v${{ env.GODOT_VERSION }}-stable_linux.x86_64 \
            --headless \
            --path ${{ env.GODOT_PROJECT_FOLDER }} \
            --export-${{ env.BUILD_MODE }} Windows ${{ env.EXPORT_FOLDER_WINDOWS }}/${{ env.APPLICATION_NAME }}.exe || true
          pushd ${{ env.EXPORT_FOLDER_WINDOWS }}
          zip -r ${{ env.APPLICATION_NAME }}_windows_${{ env.BUILD_MODE }}_${{ env.VERSION }}.zip .
          popd
          mv ${{ env.EXPORT_FOLDER_WINDOWS }}/*.zip ${{ env.EXPORT_FOLDER_OUTPUT }}/

      - name: Upload Windows artifact
        if: ${{ env.BUILD_TARGET == 'windows' || env.BUILD_TARGET == 'all' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APPLICATION_NAME }}_windows_${{ env.BUILD_MODE }}_${{ env.VERSION }}
          path: ${{ env.EXPORT_FOLDER_WINDOWS }}

      - name: Build Web
        if: ${{ env.BUILD_TARGET == 'web' || env.BUILD_TARGET == 'all' }}
        run: |
          ./Godot_v${{ env.GODOT_VERSION }}-stable_linux.x86_64 \
            --headless \
            --path ${{ env.GODOT_PROJECT_FOLDER }} \
            --export-${{ env.BUILD_MODE }} Web ${{ env.EXPORT_FOLDER_WEB }}/index.html || true
          pushd ${{ env.EXPORT_FOLDER_WEB }}
          zip -r ${{ env.APPLICATION_NAME }}_web_${{ env.BUILD_MODE }}_${{ env.VERSION }}.zip .
          popd
          mv ${{ env.EXPORT_FOLDER_WEB }}/*.zip ${{ env.EXPORT_FOLDER_OUTPUT }}/

      - name: Upload Web artifact
        if: ${{ env.BUILD_TARGET == 'web' || env.BUILD_TARGET == 'all' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APPLICATION_NAME }}_web_${{ env.BUILD_MODE }}_${{ env.VERSION }}
          path: ${{ env.EXPORT_FOLDER_WEB }}

      - name: Create release
        if: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          files: |
            ${{ env.EXPORT_FOLDER_OUTPUT }}/${{ env.APPLICATION_NAME }}_linux_${{ env.BUILD_MODE }}_${{ env.VERSION }}.tar
            ${{ env.EXPORT_FOLDER_OUTPUT }}/${{ env.APPLICATION_NAME }}_windows_${{ env.BUILD_MODE }}_${{ env.VERSION }}.zip
            ${{ env.EXPORT_FOLDER_OUTPUT }}/${{ env.APPLICATION_NAME }}_web_${{ env.BUILD_MODE }}_${{ env.VERSION }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
