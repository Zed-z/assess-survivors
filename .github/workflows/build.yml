name: Multi-Platform Debug/Release Build
run-name: Building debug/release version for multiple platforms

on:
  workflow_dispatch:
    inputs:
      job_target:
        description: "Platform"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - windows
          - linux
          - web

      build_mode:
        description: "Build Mode"
        required: true
        default: "debug"
        type: choice
        options:
          - debug
          - release

      run_tests:
        description: "Run GDUnit tests"
        type: boolean
        default: true

env:
  GODOT_VERSION: 4.5.1
  GODOT_PROJECT_FOLDER: .
  GODOT_PROJECT_FILE: ./project.godot
  EXPORT_FOLDER_WINDOWS: export/windows
  EXPORT_FOLDER_LINUX: export/linux
  EXPORT_FOLDER_WEB: export/web
  APPLICATION_NAME: assess_survivors

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Set extra variables
        run: |
          echo "DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
          echo "MAIN_FOLDER=$(pwd)" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip git fontconfig ca-certificates libx11-6 libxext6 libxi6 libxrandr2 libxcursor1 libxinerama1 libxxf86vm1 libglu1-mesa libpulse0 libglib2.0-0

      - name: Checkout submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Prepare Godot
        run: |
          wget -q -O godot_linux.zip https://github.com/godotengine/godot-builds/releases/download/${{ env.GODOT_VERSION }}-stable/Godot_v${{ env.GODOT_VERSION }}-stable_linux.x86_64.zip
          unzip godot_linux.zip
          wget -q -O godot_export_templates.tpz https://github.com/godotengine/godot-builds/releases/download/${{ env.GODOT_VERSION }}-stable/Godot_v${{ env.GODOT_VERSION }}-stable_export_templates.tpz
          mkdir -p ~/.local/share/godot/export_templates/${{ env.GODOT_VERSION }}.stable
          unzip godot_export_templates.tpz -d ~/.local/share/godot/export_templates/${{ env.GODOT_VERSION }}.stable
          mv ~/.local/share/godot/export_templates/${{ env.GODOT_VERSION }}.stable/templates/* ~/.local/share/godot/export_templates/${{ env.GODOT_VERSION }}.stable/
          chmod +x ./Godot_v${{ env.GODOT_VERSION }}-stable_linux.x86_64
          sed -i 's/config\/version="[^"]*"/config\/version="${{ env.DATE }}-${{ github.event.inputs.build_mode }}"/' ${{ env.GODOT_PROJECT_FILE }}

      - name: Run GDUnit4 Tests
        if: ${{ github.event.inputs.run_tests == true }}
        uses: MikeSchulze/gdUnit4-action@v1
        with:
          godot-version: ${{ env.GODOT_VERSION }}
          paths: "res://test"
          timeout: 10

      - name: Build Linux
        if: ${{ github.event.inputs.job_target == 'linux' || github.event.inputs.job_target == 'all' }}
        run: |
          mkdir -p ${{ env.EXPORT_FOLDER_LINUX }}
          ./Godot_v${{ env.GODOT_VERSION }}-stable_linux.x86_64 --headless --path ${{ env.GODOT_PROJECT_FOLDER }} --export-${{ github.event.inputs.build_mode }} Linux ${{ env.MAIN_FOLDER }}/${{ env.EXPORT_FOLDER_LINUX }}/${{ env.APPLICATION_NAME }}.x86_64 || true
          chmod +x ${{ env.EXPORT_FOLDER_LINUX }}/${{ env.APPLICATION_NAME }}.x86_64
          if [ "${{ github.event.inputs.build_mode }}" = "debug" ]; then
            chmod +x ${{ env.EXPORT_FOLDER_LINUX }}/${{ env.APPLICATION_NAME }}.sh
          fi
          tar -cvf ${{ env.APPLICATION_NAME }}_linux_${{ github.event.inputs.build_mode }}_${{ env.DATE }}.tar ${{ env.EXPORT_FOLDER_LINUX }}

      - name: Upload Linux artifact
        if: ${{ github.event.inputs.job_target == 'linux' || github.event.inputs.job_target == 'all' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APPLICATION_NAME }}_linux_${{ github.event.inputs.build_mode }}_${{ env.DATE }}.tar
          path: ${{ env.APPLICATION_NAME }}_linux_${{ github.event.inputs.build_mode }}_${{ env.DATE }}.tar

      - name: Build Windows
        if: ${{ github.event.inputs.job_target == 'windows' || github.event.inputs.job_target == 'all' }}
        run: |
          mkdir -p ${{ env.EXPORT_FOLDER_WINDOWS }}
          ./Godot_v${{ env.GODOT_VERSION }}-stable_linux.x86_64 --headless --path ${{ env.GODOT_PROJECT_FOLDER }} --export-${{ github.event.inputs.build_mode }} Windows ${{ env.MAIN_FOLDER }}/${{ env.EXPORT_FOLDER_WINDOWS }}/${{ env.APPLICATION_NAME }}.exe || true

      - name: Upload Windows artifact
        if: ${{ github.event.inputs.job_target == 'windows' || github.event.inputs.job_target == 'all' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APPLICATION_NAME }}_windows_${{ github.event.inputs.build_mode }}_${{ env.DATE }}
          path: ${{ env.EXPORT_FOLDER_WINDOWS }}/

      - name: Build Web
        if: ${{ github.event.inputs.job_target == 'web' || github.event.inputs.job_target == 'all' }}
        run: |
          mkdir -p ${{ env.EXPORT_FOLDER_WEB }}
          ./Godot_v${{ env.GODOT_VERSION }}-stable_linux.x86_64 --headless --path ${{ env.GODOT_PROJECT_FOLDER }} --export-${{ github.event.inputs.build_mode }} Web ${{ env.MAIN_FOLDER }}/${{ env.EXPORT_FOLDER_WEB }}/index.html || true

      - name: Upload Web artifact
        if: ${{ github.event.inputs.job_target == 'web' || github.event.inputs.job_target == 'all' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APPLICATION_NAME }}_web_${{ github.event.inputs.build_mode }}_${{ env.DATE }}
          path: ${{ env.EXPORT_FOLDER_WEB }}/
